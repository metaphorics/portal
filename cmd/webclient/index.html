<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portal Proxy Gateway</title>
    <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: "Pretendard", -apple-system, BlinkMacSystemFont, "Segoe UI",
                Roboto, sans-serif;
            background: #000;
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        #loading-screen.hide {
            opacity: 0;
            pointer-events: none;
        }

        #loading-logo {
            position: relative;
            max-width: 500px;
            width: 90%;
            margin-bottom: 40px;
            /* 컨테이너 쿼리를 위한 설정 */
            container-type: inline-size;
        }


        .logo-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 10% 1%;
            box-sizing: border-box;
            pointer-events: none;
        }

        .logo-title {
            font-family: "Pretendard", sans-serif;
            /* 51.5px at 500px container = 51.5/500*100 = 10.3cqw */
            font-size: 10.3cqw;
            font-weight: 600;
            color: #ffffff;
            letter-spacing: 0.2em;
            text-align: center;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            margin: 0;
        }

        .logo-subtitle {
            font-family: "Pretendard", sans-serif;
            /* 18px at 500px container = 18/500*100 = 3.6cqw */
            font-size: 3.6cqw;
            font-weight: 600;
            color: #ffffff;
            letter-spacing: -0.05em;
            text-align: center;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.4);
            margin: 0;
        }

        .loading-bar-container {
            width: 300px;
            max-width: 80%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
            animation: loading 1.5s ease-in-out infinite;
        }

        @keyframes loading {
            0% {
                width: 0%;
                margin-left: 0%;
            }

            50% {
                width: 50%;
                margin-left: 25%;
            }

            100% {
                width: 0%;
                margin-left: 100%;
            }
        }

        .loading-text {
            color: rgba(255, 255, 255, 0.7);
            margin-top: 20px;
            font-size: 14px;
            text-align: center;
            transition: color 0.3s ease;
        }

        .loading-text.error {
            color: #ef4444;
        }
    </style>
</head>

<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div id="loading-logo">
            <div class="logo-overlay">
                <h1 class="logo-title">PORTAL</h1>
                <p class="logo-subtitle">LOCAL TO WEB. INSTANT ACCESS.</p>
            </div>
        </div>
        <div class="loading-bar-container" id="loading-bar-container">
            <div class="loading-bar"></div>
        </div>
        <div class="loading-text" id="loading-text">
            Initializing Portal Network...
        </div>
    </div>

    <script>
        // In-app browser detection and redirect handler
        (function () {
            const userAgent = navigator.userAgent.toLowerCase();
            const finalUrl = window.location.href;

            // Detect various in-app browsers
            const isKakao = /kakaotalk/i.test(userAgent);
            const isNaver = /naver/i.test(userAgent);
            const isFacebook = /fb|fbav|fban/i.test(userAgent);
            const isInstagram = /instagram/i.test(userAgent);
            const isLine = /line/i.test(userAgent);
            const isInAppBrowser =
                isKakao || isNaver || isFacebook || isInstagram || isLine;
            const isAndroid = /android/.test(userAgent);
            const isIOS = /ipad|iphone|ipod/.test(userAgent);

            if (!isInAppBrowser) {
                return; // Not in-app browser, proceed normally
            }

            // Handle redirection to external browser
            if (isAndroid) {
                if (isKakao) {
                    location.href =
                        "kakaotalk://web/openExternal?url=" +
                        encodeURIComponent(finalUrl);
                    setTimeout(() => {
                        location.href = "kakaotalk://inappbrowser/close";
                    }, 10);
                } else {
                    // Use Intent to open in Chrome or default browser
                    const intentUrl =
                        "intent://" +
                        finalUrl.replace(/^https?:\/\//, "") +
                        "#Intent;scheme=https;action=android.intent.action.VIEW;end";
                    location.href = intentUrl;
                }
                return; // Stop execution
            } else if (isIOS) {
                if (isKakao) {
                    location.href =
                        "kakaotalk://web/openExternal?url=" +
                        encodeURIComponent(finalUrl);
                    // Set up auto-close listener for iOS KakaoTalk
                    document.addEventListener("visibilitychange", () => {
                        if (document.visibilityState == "visible") {
                            location.href = "kakaoweb://closeBrowser";
                        }
                    });
                } else {
                    // For other iOS in-app browsers, show message in loading screen
                    // updateLoadingText("⚠️ Please open in external browser (Safari)");
                    // document.getElementById("loading-text").classList.add("error");
                }
                return; // Stop execution
            }
        })();
    </script>
    <script>
        // Update loading text
        function updateLoadingText(message, isError = false) {
            const loadingText = document.getElementById("loading-text");
            if (loadingText) {
                loadingText.textContent = message;
                if (isError) {
                    loadingText.classList.add("error");
                } else {
                    loadingText.classList.remove("error");
                }
            }
        }

        // Show error in loading text
        function showError(error, context = "") {
            let errorMessage = "";
            if (typeof error === "string") {
                errorMessage = error;
            } else if (error instanceof Error) {
                errorMessage = `${error.message}`;
            } else {
                errorMessage = "An error occurred";
            }

            if (context) {
                errorMessage = `⚠️ ${context}: ${errorMessage}`;
            } else {
                errorMessage = `⚠️ ${errorMessage}`;
            }

            updateLoadingText(errorMessage, true);
            console.error(`[Portal Error - ${context}]`, error);
        }

        // Global error handler
        window.addEventListener("error", (event) => {
            showError(event.error || event.message, "Error");
            event.preventDefault();
        });

        // Unhandled promise rejection handler
        window.addEventListener("unhandledrejection", (event) => {
            showError(event.reason, "Promise Error");
            event.preventDefault();
        });

        // Listen for errors from Service Worker
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.addEventListener("message", (event) => {
                if (event.data && event.data.type === "SW_ERROR") {
                    const error = event.data.error;
                    showError(error.message, "Service Worker Error");
                }
            });
        }

        async function registerServiceWorker() {
            let retryCount = 0;
            const maxRetries = 30; // 3초 (30 × 100ms)

            const checkWASMReady = async () => {
                try {
                    const resp = await fetch("/e8c2c70c-ec4a-40b2-b8af-d5638264f831", {
                        cache: "no-store",
                    });
                    const text = await resp.text();

                    if (text === "ACK-e8c2c70c-ec4a-40b2-b8af-d5638264f831") {
                        updateLoadingText("Portal Network Ready!");
                        setTimeout(() => {
                            window.location.reload();
                        }, 500);
                    } else if (text === "NAK-e8c2c70c-ec4a-40b2-b8af-d5638264f831") {
                        retryCount++;
                        if (retryCount > maxRetries) {
                            throw new Error(
                                `WASM initialization timeout after ${maxRetries} retries`
                            );
                        }
                        updateLoadingText(
                            `Initializing WASM... (${retryCount}/${maxRetries})`
                        );
                        setTimeout(checkWASMReady, 100);
                    } else {
                        if (text.includes("<!DOCTYPE") || text.includes("<html>")) {
                            throw new Error("Service Worker not active - please refresh");
                        } else {
                            throw new Error(
                                `Unexpected response: ${text.substring(0, 50)}`
                            );
                        }
                    }
                } catch (error) {
                    showError(error, "Connection");
                }
            };

            const waitForController = () => {
                return new Promise((resolve, reject) => {
                    const checkController = () => {
                        if (navigator.serviceWorker.controller) {
                            resolve();
                            return true;
                        }
                        return false;
                    };

                    if (checkController()) {
                        return;
                    }

                    let timeoutId;
                    let pollIntervalId;

                    const onControllerChange = () => {
                        if (checkController()) {
                            clearTimeout(timeoutId);
                            clearInterval(pollIntervalId);
                            navigator.serviceWorker.removeEventListener(
                                "controllerchange",
                                onControllerChange
                            );
                        }
                    };

                    navigator.serviceWorker.addEventListener(
                        "controllerchange",
                        onControllerChange
                    );

                    pollIntervalId = setInterval(() => {
                        if (checkController()) {
                            clearTimeout(timeoutId);
                            clearInterval(pollIntervalId);
                            navigator.serviceWorker.removeEventListener(
                                "controllerchange",
                                onControllerChange
                            );
                        }
                    }, 100);

                    timeoutId = setTimeout(() => {
                        clearInterval(pollIntervalId);
                        navigator.serviceWorker.removeEventListener(
                            "controllerchange",
                            onControllerChange
                        );

                        if (navigator.serviceWorker.controller) {
                            resolve();
                        } else {
                            reject(new Error("Service Worker activation timeout"));
                            setTimeout(() => {
                                location.reload();
                            }, 500);
                        }
                    }, 3000);
                });
            };

            try {
                if (!("serviceWorker" in navigator)) {
                    throw new Error("Service Worker not supported in this browser");
                }

                updateLoadingText("Registering Service Worker...");

                const registration = await navigator.serviceWorker.register(
                    "/service-worker.js",
                    {
                        scope: "/",
                        updateViaCache: "none",
                    }
                );

                if (!navigator.serviceWorker.controller && registration.active) {
                    registration.active.postMessage({ type: "CLAIM_CLIENTS" });
                }

                updateLoadingText("Activating Service Worker...");

                await navigator.serviceWorker.ready;

                if (!navigator.serviceWorker.controller) {
                    updateLoadingText("Waiting for activation...");
                    try {
                        await Promise.race([
                            waitForController(),
                            new Promise((resolve) => setTimeout(resolve, 500))
                        ]);
                    } catch (error) {
                        // Ignore timeout, proceed anyway
                    }
                }

                updateLoadingText("Connecting to Portal Network...");

                setTimeout(checkWASMReady, 100);
            } catch (error) {
                showError(error, "Initialization");
            }
        }

        registerServiceWorker();
    </script>
</body>

</html>
